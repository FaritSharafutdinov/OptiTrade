import pandas as pd
import pandas_ta as ta
import numpy as np

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
# ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–û –ò–ú–Ø –§–ê–ô–õ–ê –ù–ê –¢–û, –ö–û–¢–û–†–û–ï –ë–´–õ–û –°–û–•–†–ê–ù–ï–ù–û –ü–ï–†–í–´–ú –°–ö–†–ò–ü–¢–û–ú
INPUT_FILENAME = 'BTC_USDT_OI_1h_2Y.csv' 
OUTPUT_FILENAME = 'BTC_USDT_OI_FEATURES_1h_2Y.csv'
# --------------------

def calculate_features(df: pd.DataFrame) -> pd.DataFrame:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (MACD, RSI, ATR) –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç 
    –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏—á–∏ (Hour, Day of Week).
    
    :param df: –ò—Å—Ö–æ–¥–Ω—ã–π DataFrame —Å OHLCV –∏ Open Interest.
    :return: DataFrame —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º–∏ —Ñ–∏—á–∞–º–∏.
    """
    print("üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—á–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∏—á...")
    
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã –∏–º–µ—é—Ç —á–∏—Å–ª–æ–≤–æ–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö
    cols_to_numeric = ['Open', 'High', 'Low', 'Close', 'Volume']
    for col in cols_to_numeric:
        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è, –∑–∞–º–µ–Ω—è—è –Ω–µ–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ NaN
        df[col] = pd.to_numeric(df[col], errors='coerce')
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å NaN, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –ø—Ä–∏ —Å–±–æ—Ä–µ –∏–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
    df.dropna(subset=['Close', 'Volume'], inplace=True)
    
    # 1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (pandas_ta)
    
    ### MACD (Moving Average Convergence Divergence)
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: fast=12, slow=26, signal=9
    df.ta.macd(close='Close', fast=12, slow=26, signal=9, append=True)
    # –î–æ–±–∞–≤–ª—è—Ç—Å—è —Å—Ç–æ–ª–±—Ü—ã: MACD_12_26_9, MACDh_12_26_9, MACDs_12_26_9
    print("   ‚úÖ –†–∞—Å—Å—á–∏—Ç–∞–Ω MACD.")

    ### RSI (Relative Strength Index)
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–∏–æ–¥ 14
    df.ta.rsi(close='Close', length=14, append=True)
    # –î–æ–±–∞–≤–∏—Ç—Å—è —Å—Ç–æ–ª–±–µ—Ü: RSI_14
    print("   ‚úÖ –†–∞—Å—Å—á–∏—Ç–∞–Ω RSI.")
    
    ### ATR (Average True Range)
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–∏–æ–¥ 14
    df.ta.atr(high='High', low='Low', close='Close', length=14, append=True)
    # –î–æ–±–∞–≤–∏—Ç—Å—è —Å—Ç–æ–ª–±–µ—Ü: ATR_14
    print("   ‚úÖ –†–∞—Å—Å—á–∏—Ç–∞–Ω ATR.")

    # 2. VAP (Volume-Weighted Average Price) - –†–∞—Å—á–µ—Ç VWAP (–±–æ–ª–µ–µ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ)
    # VWAP —á–∞—Å—Ç–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–Ω–µ–≤–Ω–æ–π –∏–ª–∏ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π —Å–≤–µ—á–∏ –∏ —Ç—Ä–µ–±—É–µ—Ç 
    # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏, –ø–æ—ç—Ç–æ–º—É –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º—ã —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º:
    # CUSUM VWAP (–∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π VWAP –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥) - –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç.
    # –î–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –≤–µ—Ä—Å–∏—é **VP (Volume Price)** –∫–∞–∫ (Close * Volume)
    # –≠—Ç–æ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ–∫—Å–∏-—Ñ–∏—á–∞.
    # VWAP (–∫–∞–∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä) - —Ç—Ä–µ–±—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –æ–∫–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 14 —á–∞—Å–æ–≤)
    df['VWAP_14'] = df.ta.vwap(close='Close', volume='Volume', length=14)
    print("   ‚úÖ –†–∞—Å—Å—á–∏—Ç–∞–Ω 14-–ø–µ—Ä–∏–æ–¥–Ω—ã–π VWAP.")
    
    # 3. Time-Based Features (–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏—á–∏)
    
    # Hour of Day (0-23)
    df['Hour_of_Day'] = df.index.hour
    
    # Day of Week (0=–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 6=–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)
    df['Day_of_Week'] = df.index.dayofweek
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏—á–∏ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã (—á–∞—Å—Ç–æ –ø–æ–ª–µ–∑–Ω—ã)
    df['Day_of_Month'] = df.index.day
    df['Month'] = df.index.month
    
    print("   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏—á–∏.")
    
    # 4. –û—á–∏—Å—Ç–∫–∞ NaN (–ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–æ–≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤)
    # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 26 —Å–≤–µ—á–µ–π –¥–ª—è MACD), 
    # –ø–æ—ç—Ç–æ–º—É –≤ –Ω–∞—á–∞–ª–µ DataFrame –ø–æ—è–≤—è—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è NaN. –ò—Ö –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å.
    initial_length = len(df)
    df.dropna(inplace=True)
    print(f"üßπ –£–¥–∞–ª–µ–Ω–æ {initial_length - len(df)} —Å—Ç—Ä–æ–∫ —Å NaN –≤ –Ω–∞—á–∞–ª–µ.")
    
    print(f"\n‚úÖ –†–∞—Å—á–µ—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä DataFrame: {len(df)}")
    
    return df

# --- –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ ---
if __name__ == '__main__':
    try:
        # 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 'timestamp' –∫–∞–∫ –∏–Ω–¥–µ–∫—Å
        df = pd.read_csv(INPUT_FILENAME, index_col='timestamp', parse_dates=True)
        print(f"–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: {INPUT_FILENAME}. –†–∞–∑–º–µ—Ä: {len(df)}")
        
        # 2. –†–∞—Å—á–µ—Ç –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏—á
        df_features = calculate_features(df.copy())
        
        # 3. –í—ã–≤–æ–¥ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        print("\n" + "="*70)
        print("–ì–û–¢–û–í–´–ô DATAFRAME –° –§–ò–ß–ê–ú–ò (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫):")
        # –í—ã–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã –∏ Close –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
        macd_h_col = [col for col in df_features.columns if 'MACDh' in col][0]
        # –ù–∞—Ö–æ–¥–∏–º RSI
        rsi_col = [col for col in df_features.columns if 'RSI' in col][0]
        # –ù–∞—Ö–æ–¥–∏–º ATR (–º–æ–∂–µ—Ç –±—ã—Ç—å 'ATR' –∏–ª–∏ 'ATR_14')
        atr_col = [col for col in df_features.columns if 'ATR' in col and 'VWAP' not in col][0]
        # –ù–∞—Ö–æ–¥–∏–º VWAP
        vwap_col = [col for col in df_features.columns if 'VWAP' in col][0]


        cols_to_display = ['Close', 'Open Interest', macd_h_col, rsi_col, atr_col, vwap_col, 'Hour_of_Day', 'Day_of_Week']
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º .tail() –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å—Ç—Ä–æ–∫, —Ç–∞–∫ –∫–∞–∫ –≤ –Ω–∞—á–∞–ª–µ –º–æ–≥—É—Ç –±—ã—Ç—å NaN
        print(df_features[cols_to_display].tail())
        print("="*70)
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –Ω–æ–≤—ã–π CSV —Ñ–∞–π–ª
        df_features.to_csv(OUTPUT_FILENAME)
        print(f"‚úÖ –û–±–æ–≥–∞—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: {OUTPUT_FILENAME}")
        
    except FileNotFoundError:
        print(f"‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª '{INPUT_FILENAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–≤—ã–π —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª –¥–∞–Ω–Ω—ã–µ.")
    except Exception as e:
        print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
